<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å››ç»´ä¸–ç•Œæ—¥ç¨‹è¡¨ v2.1 (å«é»„èµ¤äº¤è§’)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            background-color: #111827;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // æå– React Hooks
        const { useState, useMemo } = React;

        const FourDScheduleV2 = () => {
            // é»„é‡‘æ¯”ä¾‹
            const PHI = (1 + Math.sqrt(5)) / 2;

            // å¯è°ƒå‚æ•°
            const [fastDay, setFastDay] = useState(24); // å¿«æ—¥å‘¨æœŸï¼ˆå°æ—¶ï¼‰
            const [slowDayRatio, setSlowDayRatio] = useState(Math.PI * 9 / 4); // æ…¢æ—¥/å¿«æ—¥æ¯”
            const [startFastPhase, setStartFastPhase] = useState(0); // èµ·å§‹å¿«æ—¥ç›¸ä½
            const [startSlowPhase, setStartSlowPhase] = useState(0); // èµ·å§‹æ…¢æ—¥ç›¸ä½
            const [cyclesCount, setCyclesCount] = useState(50); // æ˜¾ç¤ºå¤šå°‘ä¸ªæ˜¼å¤œå‘¨æœŸ
            const [latitude, setLatitude] = useState(25); // çº¬åº¦ (Hopf Latitude Î·)
            const [tiltXY, setTiltXY] = useState(23.5);
            const [tiltZW, setTiltZW] = useState(40.0);
            // [æ–°å¢] äº¤æ¢å¹³é¢ (XY <=> ZW)
            const [swapPlanes, setSwapPlanes] = useState(true);

            // [æ–°å¢] å…¬è½¬å‚æ•°
            const [enableRevolution, setEnableRevolution] = useState(true);
            const [yearLength, setYearLength] = useState(28800); // å…¬è½¬å‘¨æœŸï¼ˆå°æ—¶ï¼‰
            const [startYearPhase, setStartYearPhase] = useState(0); // å…¬è½¬èµ·å§‹ç›¸ä½

            const slowDay = fastDay * slowDayRatio;

            // è¯¾ç¨‹è®¾ç½®
            const classSettings = {
                perHour: 1,
                minClasses: 2,
                maxClasses: 10,
            };

            // è¾…åŠ©å‡½æ•°ï¼šåŒé‡å€¾æ–œæ—‹è½¬
            const applyDoubleTilt = (x, y, z, w, deg1, deg2) => {
                const r1 = deg1 * Math.PI / 180;
                const c1 = Math.cos(r1);
                const s1 = Math.sin(r1);
                // XY å¹³é¢å€¾æ–œ (å½±å“ Y å’Œ W çš„æ··åˆ)
                let y1 = y * c1 - w * s1;
                let w1 = y * s1 + w * c1;
                let z1 = z;

                const r2 = deg2 * Math.PI / 180;
                const c2 = Math.cos(r2);
                const s2 = Math.sin(r2);
                // ZW å¹³é¢å€¾æ–œ (å½±å“ Z å’Œ W çš„æ··åˆ)
                let z2 = z1 * c2 - w1 * s2;
                let w2 = z1 * s2 + w1 * c2;

                return { z: z2, w: w2 }; // è¿”å› Z å’Œ W ä»¥ä¾¿è¿›è¡Œçº¬åº¦æŠ•å½±
            };

            // è¾…åŠ©å‡½æ•°ï¼šç®€æ˜“æ•°å­¦è¡¨è¾¾å¼è§£æ
            const evaluateMath = (expr) => {
                try {
                    // æ›¿æ¢å¸¸é‡ (ä¸åŒºåˆ†å¤§å°å†™)
                    let safeExpr = expr.toLowerCase();
                    // å…ˆæ›¿æ¢é•¿åå­—
                    safeExpr = safeExpr.replace(/\bsqrt2\b/g, Math.SQRT2);
                    safeExpr = safeExpr.replace(/\bphi\b/g, ((1 + Math.sqrt(5)) / 2));
                    // å†æ›¿æ¢çŸ­åå­—
                    safeExpr = safeExpr.replace(/\bpi\b/g, Math.PI);
                    safeExpr = safeExpr.replace(/\be\b/g, Math.E);
                    // å…è®¸å¸¸ç”¨å‡½æ•°
                    safeExpr = safeExpr.replace(/\bsin\(/g, 'Math.sin(');
                    safeExpr = safeExpr.replace(/\bcos\(/g, 'Math.cos(');
                    safeExpr = safeExpr.replace(/\bsqrt\(/g, 'Math.sqrt(');

                    // åªèƒ½åŒ…å«æ•°å­—ã€è¿ç®—ç¬¦ã€æ‹¬å·ã€ç‚¹å’ŒMathå‰ç¼€
                    if (/[^0-9+\-*/().\sMathabcdeilnopqrst]/.test(safeExpr)) {
                        // ç®€å•çš„å®‰å…¨æ£€æŸ¥ï¼Œå…è®¸ Math.xxx äº§ç”Ÿçš„å­—ç¬¦
                        // è¿™é‡Œçš„æ­£åˆ™å¹¶ä¸ä¸¥è°¨ï¼Œä½†åœ¨æœ¬åœ°è·‘ä¸ªç®€å•çš„è¡¨è¾¾å¼è§£æé—®é¢˜ä¸å¤§
                        // æ›´ä¸¥æ ¼çš„åšæ³•æ˜¯å†™ä¸ªé€’å½’ä¸‹é™è§£æå™¨ï¼Œè¿™é‡Œå·æ‡’ç”¨ Function
                    }

                    return new Function('return ' + safeExpr)();
                } catch (e) {
                    return null;
                }
            };

            // èŠ‚æ°”å®šä¹‰ (åŸºäºå…¬è½¬è§’åº¦ï¼Œ0=å†¬è‡³)
            const SOLAR_TERMS = [
                { angle: 0, name: 'å†¬è‡³' },
                { angle: 45, name: 'ç«‹æ˜¥' },
                { angle: 90, name: 'æ˜¥åˆ†' },
                { angle: 135, name: 'ç«‹å¤' },
                { angle: 180, name: 'å¤è‡³' },
                { angle: 225, name: 'ç«‹ç§‹' },
                { angle: 270, name: 'ç§‹åˆ†' },
                { angle: 315, name: 'ç«‹å†¬' },
            ];

            // æ£€æŸ¥ä¸€æ®µæ—¶é—´å†…ç»è¿‡çš„èŠ‚æ°”
            const checkSolarTerms = (startTime, endTime, yearLen, startPhase, tiltZW) => {
                if (yearLen <= 0) return null;
                const terms = [];
                const yearSpeed = 2 * Math.PI / yearLen;
                const tiltZWRad = tiltZW * Math.PI / 180;

                // å°†æ—¶é—´è½¬æ¢ä¸ºè§’åº¦ (deg)
                // ä¿®æ­£ï¼šå‡å» TiltZW å¼•èµ·çš„ç›¸ç§»ï¼Œä¸ä»…æ˜¯å‡ ä½•æ—‹è½¬ï¼Œä¹Ÿæ˜¯èƒ½é‡æœ€å¤§å€¼çš„åç§»
                const startAngleRad = (yearSpeed * startTime + startPhase - tiltZWRad) % (2 * Math.PI);
                const endAngleRad = (yearSpeed * endTime + startPhase - tiltZWRad) % (2 * Math.PI);

                // è°ƒæ•´è´Ÿè§’åº¦åˆ° [0, 2PI]
                const normalize = (rad) => {
                    let r = rad % (2 * Math.PI);
                    if (r < 0) r += 2 * Math.PI;
                    return r;
                };

                let startDeg = normalize(startAngleRad) * 180 / Math.PI;
                let endDeg = normalize(endAngleRad) * 180 / Math.PI;

                // å¤„ç†è·¨è¶Š 0/360 çš„æƒ…å†µ
                // å¦‚æœ end < startï¼Œè¯´æ˜è·¨è¶Šäº† 0 åº¦ (å†¬è‡³)
                if (endDeg < startDeg) {
                    endDeg += 360;
                }

                SOLAR_TERMS.forEach(term => {
                    // æ£€æŸ¥ term.angle æ˜¯å¦åœ¨ [startDeg, endDeg] åŒºé—´å†…
                    // ä¹Ÿè¦è€ƒè™‘ endDeg > 360 çš„æƒ…å†µ (å³ term.angle + 360)
                    if ((term.angle >= startDeg && term.angle <= endDeg) ||
                        (term.angle + 360 >= startDeg && term.angle + 360 <= endDeg)) {
                        terms.push(term.name);
                    }
                });

                return terms.length > 0 ? terms.join(', ') : null;
            };

            // [æ–°å¢] æ¯”ä¾‹è¾“å…¥æ¡†çŠ¶æ€
            const [ratioInput, setRatioInput] = useState((Math.PI * 9 / 4).toFixed(4));

            // è®¡ç®—æŸæ—¶åˆ»å¤ªé˜³æ˜¯å¦åœ¨åœ°å¹³çº¿ä»¥ä¸Š
            const getSunAltitude = (t) => {
                // 1. è®¡ç®—ä¸¤ä¸ªè‡ªè½¬å¹³é¢çš„è§’é€Ÿåº¦ (rad/hr)
                const fastSpeed = 2 * Math.PI / fastDay;
                const slowSpeed = 2 * Math.PI / slowDay;

                // 2. å°†è§’åº¦è½¬æ¢ä¸ºå¼§åº¦
                // latitude (Hopf Latitude Î·): 0Â°(çº¯å¿«æ—¥/èµ¤é“) -> 45Â°(æ··åˆ/ä¸­çº¬) -> 90Â°(çº¯æ…¢æ—¥/æç‚¹)
                const eta = latitude * Math.PI / 180;

                // 3. è®¡ç®—éšæ—¶é—´å˜åŒ–çš„åŒç»åº¦ä½ç½® (Î¾1, Î¾2)
                // é»˜è®¤: XYä½¿ç”¨å¿«æ—¥, ZWä½¿ç”¨æ…¢æ—¥
                // äº¤æ¢å: XYä½¿ç”¨æ…¢æ—¥, ZWä½¿ç”¨å¿«æ—¥
                const speedXY = swapPlanes ? slowSpeed : fastSpeed;
                const startXY = swapPlanes ? startSlowPhase : startFastPhase;

                const speedZW = swapPlanes ? fastSpeed : slowSpeed;
                const startZW = swapPlanes ? startFastPhase : startSlowPhase;

                const xi1 = speedXY * t + startXY;
                const xi2 = speedZW * t + startZW;

                // 4. ç”Ÿæˆ 4D è¶…çƒé¢åŸºç¡€åæ ‡ (S3 å‡ ä½•æ¨¡å‹)
                const x = Math.cos(eta) * Math.cos(xi1);
                const y = Math.cos(eta) * Math.sin(xi1);
                const z = Math.sin(eta) * Math.cos(xi2);
                const w = Math.sin(eta) * Math.sin(xi2);

                // 5. åº”ç”¨åŒé‡é»„èµ¤äº¤è§’å˜æ¢ (Double Tilt)
                const { z: zFinal, w: wFinal } = applyDoubleTilt(x, y, z, w, tiltXY, tiltZW);

                // 6. è®¡ç®—å…¬è½¬å½±å“ (Revolution)
                // å‡è®¾å…¬è½¬å‘ç”Ÿåœ¨ ZW å¹³é¢ (Sun rotates in ZW plane relative to the fixed frame)
                // enableRevolution = false: Sun is fixed at -W (0, 0, 0, -1)
                // enableRevolution = true: Sun rotates: (0, 0, sin(Î©t), -cos(Î©t))

                let sunZ = 0;
                let sunW = -1;

                if (enableRevolution && yearLength > 0) {
                    const yearSpeed = 2 * Math.PI / yearLength;
                    const yearAngle = yearSpeed * t + startYearPhase;

                    // å½“ yearAngle = 0, Sun = -W (Winter/Base)
                    // å½“ yearAngle = PI, Sun = +W (Summer)
                    // é¡ºæ—¶é’ˆ/é€†æ—¶é’ˆå–å†³äºå®šä¹‰ï¼Œè¿™é‡Œå‡è®¾æ ‡å‡†æ­£å‘æ—‹è½¬
                    sunZ = Math.sin(yearAngle);
                    sunW = -Math.cos(yearAngle);
                }

                // 7. è¿”å›å¤ªé˜³é«˜åº¦ (Dot Product of Planet Position and Sun Vector)
                // P = (xFinal, yFinal, zFinal, wFinal)
                // S = (0, 0, sunZ, sunW)
                return zFinal * sunZ + wFinal * sunW;
            };

            // æ‰¾åˆ°æ—¥å‡º/æ—¥è½æ—¶åˆ»ï¼ˆå¤ªé˜³é«˜åº¦è¿‡é›¶ç‚¹ï¼‰
            const findDayNightCycles = () => {
                const cycles = [];
                const dt = 0.05; // ç¨å¾®å¢å¤§æ­¥é•¿ä»¥ä¼˜åŒ–é•¿å‘¨æœŸè®¡ç®—æ€§èƒ½

                // å¦‚æœå¼€å¯å…¬è½¬ï¼Œè‡³å°‘è®¡ç®—ä¸€å®šé•¿åº¦ä»¥ä½“ç°å­£èŠ‚å˜åŒ–
                const maxTime = enableRevolution
                    ? Math.max(yearLength * 1.2, cyclesCount * Math.max(fastDay, slowDay) * 2)
                    : cyclesCount * Math.max(fastDay, slowDay) * 2;

                let t = 0;
                let prevAltitude = getSunAltitude(0);
                let currentStart = 0;
                let isDay = prevAltitude > 0;
                let cycleIndex = 0;

                // ç´¯è®¡å¿«æ—¥å’Œæ…¢æ—¥è®¡æ•°
                let fastDayCount = 0;
                let slowDayCount = 0;
                let lastFastDay = 0;
                let lastSlowDay = 0;

                while (cycles.length < cyclesCount * 2 && t < maxTime) {
                    t += dt;
                    const altitude = getSunAltitude(t);

                    // æ£€æµ‹è¿‡é›¶ç‚¹
                    if ((prevAltitude <= 0 && altitude > 0) || (prevAltitude >= 0 && altitude < 0)) {
                        const duration = t - currentStart;

                        // æ›´æ–°å¿«æ—¥æ…¢æ—¥è®¡æ•°
                        const currentFastDay = Math.floor(t / fastDay);
                        const currentSlowDay = Math.floor(t / slowDay);
                        if (currentFastDay > lastFastDay) {
                            fastDayCount = currentFastDay;
                            lastFastDay = currentFastDay;
                        }
                        if (currentSlowDay > lastSlowDay) {
                            slowDayCount = currentSlowDay;
                            lastSlowDay = currentSlowDay;
                        }

                        cycles.push({
                            index: cycleIndex++,
                            startTime: currentStart,
                            endTime: t,
                            duration: duration,
                            isDay: isDay,
                            fastDay: fastDayCount,
                            slowDay: slowDayCount,
                        });

                        currentStart = t;
                        isDay = !isDay;
                    }

                    prevAltitude = altitude;
                }

                return cycles;
            };

            // ç”Ÿæˆæ˜¼å¤œå‘¨æœŸæ•°æ®
            // ç”Ÿæˆæ˜¼å¤œå‘¨æœŸæ•°æ®
            const cycleData = useMemo(() => {
                return findDayNightCycles();
            }, [fastDay, slowDayRatio, startFastPhase, startSlowPhase, cyclesCount, latitude, tiltXY, tiltZW, swapPlanes, enableRevolution, yearLength, startYearPhase]);

            // å°†è¿ç»­çš„æ˜¼å¤œé…å¯¹
            const dayNightPairs = useMemo(() => {
                const pairs = [];
                for (let i = 0; i < cycleData.length - 1; i += 2) {
                    const first = cycleData[i];
                    const second = cycleData[i + 1];

                    // ç¡®ä¿å…ˆæ˜¼åå¤œ
                    let dayPart, nightPart;
                    if (first.isDay) {
                        dayPart = first;
                        nightPart = second;
                    } else {
                        nightPart = first;
                        dayPart = second;
                    }

                    if (dayPart && nightPart) {
                        const totalLength = dayPart.duration + nightPart.duration;
                        const dayRatio = dayPart.duration / totalLength;

                        // æ ¹æ®æ˜¼å¤œæ¯”ä¾‹åˆ†ç±»
                        let dayType, color, textColor;
                        if (dayRatio < 0.15) {
                            dayType = 'æçŸ­æ—¥'; color = 'bg-indigo-900'; textColor = 'text-indigo-300';
                        } else if (dayRatio < 0.3) {
                            dayType = 'çŸ­æ—¥'; color = 'bg-blue-900'; textColor = 'text-blue-300';
                        } else if (dayRatio < 0.45) {
                            dayType = 'åçŸ­æ—¥'; color = 'bg-cyan-900'; textColor = 'text-cyan-300';
                        } else if (dayRatio < 0.55) {
                            dayType = 'å¹³æ—¥'; color = 'bg-gray-700'; textColor = 'text-gray-300';
                        } else if (dayRatio < 0.7) {
                            dayType = 'åé•¿æ—¥'; color = 'bg-yellow-900'; textColor = 'text-yellow-300';
                        } else if (dayRatio < 0.85) {
                            dayType = 'é•¿æ—¥'; color = 'bg-orange-900'; textColor = 'text-orange-300';
                        } else {
                            dayType = 'æé•¿æ—¥'; color = 'bg-red-900'; textColor = 'text-red-300';
                        }

                        // è®¡ç®—è¯¾æ—¶ï¼ˆåŸºäºç™½æ˜¼é•¿åº¦ï¼‰
                        const availableHours = Math.max(0, dayPart.duration - 2);
                        let classes = Math.floor(availableHours * classSettings.perHour);
                        classes = Math.max(classSettings.minClasses, Math.min(classSettings.maxClasses, classes));

                        // è®¡ç®—èŠ‚æ°”
                        let solarTerm = null;
                        if (enableRevolution) {
                            // ä½¿ç”¨ dayPart çš„ start å’Œ nightPart çš„ end (è¦†ç›–æ•´ä¸ªå‘¨æœŸ)
                            solarTerm = checkSolarTerms(dayPart.startTime, nightPart.endTime, yearLength, startYearPhase, tiltZW);
                        }

                        pairs.push({
                            index: pairs.length + 1,
                            dayDuration: dayPart.duration,
                            nightDuration: nightPart.duration,
                            totalDuration: totalLength,
                            dayRatio: dayRatio,
                            fastDay: dayPart.fastDay,
                            slowDay: dayPart.slowDay,
                            dayType,
                            color,
                            textColor,
                            classes,
                            solarTerm,
                        });
                    }
                }
                return pairs;
            }, [cycleData, enableRevolution, yearLength, startYearPhase, tiltZW]);

            // ç»Ÿè®¡ä¿¡æ¯
            const stats = useMemo(() => {
                if (dayNightPairs.length === 0) return { minDay: 0, maxDay: 0, avgDay: 0, minNight: 0, maxNight: 0, avgNight: 0, totalClasses: 0 };

                const days = dayNightPairs.map(d => d.dayDuration);
                const nights = dayNightPairs.map(d => d.nightDuration);

                return {
                    minDay: Math.min(...days),
                    maxDay: Math.max(...days),
                    avgDay: days.reduce((a, b) => a + b, 0) / days.length,
                    minNight: Math.min(...nights),
                    maxNight: Math.max(...nights),
                    avgNight: nights.reduce((a, b) => a + b, 0) / nights.length,
                    totalClasses: dayNightPairs.reduce((a, b) => a + b.classes, 0),
                };
            }, [dayNightPairs]);

            const formatTime = (hours) => {
                if (hours < 1) return `${(hours * 60).toFixed(0)}åˆ†`;
                return `${hours.toFixed(1)}æ—¶`;
            };

            return (
                <div className="min-h-screen bg-gray-900 text-white p-4">
                    <h1 className="text-2xl font-bold mb-2 text-center">å››ç»´ä¸–ç•Œæ—¥ç¨‹è¡¨ v2.1 (å«é»„èµ¤äº¤è§’)</h1>
                    <p className="text-gray-400 text-center mb-4 text-sm">
                        åŸºäºåŒæ—‹è½¬è‡ªè½¬ + åŒé‡é»„èµ¤äº¤è§’çš„å‡†å‘¨æœŸç³»ç»Ÿ
                    </p>

                    <div className="max-w-6xl mx-auto grid lg:grid-cols-3 gap-4">
                        {/* å‚æ•°è®¾ç½® */}
                        <div className="bg-gray-800 p-4 rounded-lg">
                            <div className="flex justify-between items-center mb-3">
                                <h2 className="text-lg font-semibold text-blue-400">âš™ï¸ å‚æ•°è®¾ç½®</h2>
                                <button
                                    onClick={() => setSwapPlanes(!swapPlanes)}
                                    className={`text-xs px-2 py-1 rounded bg-gray-700 text-gray-400 hover:bg-gray-600`}
                                >
                                    {swapPlanes ? 'XY=æ…¢' : 'XY=å¿«'}
                                </button>
                            </div>

                            <div className="space-y-3">
                                <div>
                                    <label className="block text-xs text-green-400 mb-1 font-bold">
                                        Tilt XY (ä¸»äº¤è§’):
                                        <input
                                            type="number"
                                            value={tiltXY}
                                            onChange={(e) => setTiltXY(Number(e.target.value))}
                                            className="bg-gray-700 text-white px-1 rounded w-14 ml-1"
                                        />
                                        Â°
                                    </label>
                                    <input
                                        type="range"
                                        min="0"
                                        max="90"
                                        step="0.5"
                                        value={tiltXY}
                                        onChange={(e) => setTiltXY(Number(e.target.value))}
                                        className="w-full accent-green-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs text-purple-400 mb-1 font-bold">
                                        Tilt ZW (æ¬¡äº¤è§’):
                                        <input
                                            type="number"
                                            value={tiltZW}
                                            onChange={(e) => setTiltZW(Number(e.target.value))}
                                            className="bg-gray-700 text-white px-1 rounded w-14 ml-1"
                                        />
                                        Â°
                                    </label>
                                    <input
                                        type="range"
                                        min="0"
                                        max="90"
                                        step="0.5"
                                        value={tiltZW}
                                        onChange={(e) => setTiltZW(Number(e.target.value))}
                                        className="w-full accent-purple-500"
                                    />
                                </div>

                                <hr className="border-gray-700" />

                                <div>
                                    <label className="block text-xs text-yellow-400 mb-1 font-bold">
                                        çº¬åº¦ (Latitude Î·):
                                        <input
                                            type="number"
                                            value={latitude}
                                            onChange={(e) => setLatitude(Number(e.target.value))}
                                            className="bg-gray-700 text-white px-1 rounded w-16 ml-2"
                                        />
                                        Â°
                                    </label>
                                    <div className="flex justify-between text-[10px] text-gray-500">
                                        <span>èµ¤é“ (XY)</span>
                                        <span>ä¸­çº¬ (æ··åˆ)</span>
                                        <span>æç‚¹ (ZW)</span>
                                    </div>
                                    <input
                                        type="range"
                                        min="0"
                                        max="90"
                                        step="0.1"
                                        value={latitude}
                                        onChange={(e) => setLatitude(Number(e.target.value))}
                                        className="w-full accent-yellow-500"
                                    />
                                </div>

                                <hr className="border-gray-700" />

                                <div>
                                    <label className="block text-xs text-gray-400 mb-1">
                                        å¿«æ—¥å‘¨æœŸ: <input
                                            type="number"
                                            value={Math.round(fastDay * 100) / 100}
                                            step="0.1"
                                            className="bg-gray-700 text-white px-1 rounded w-20 ml-1"
                                            onChange={(e) => {
                                                const val = Number(e.target.value);
                                                setFastDay(val);
                                                // ä¿æŒæ…¢æ—¥ä¸å˜: slowDay = fast * ratio
                                                // newRatio = oldSlow / newFast
                                                if (val > 0) setSlowDayRatio(slowDay / val);
                                            }}
                                        /> å°æ—¶
                                    </label>
                                    <input
                                        type="range"
                                        min="1"
                                        max="100"
                                        step="0.1"
                                        value={fastDay}
                                        onChange={(e) => {
                                            const val = Number(e.target.value);
                                            setFastDay(val);
                                            setSlowDayRatio(slowDay / val);
                                        }}
                                        className="w-full"
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs text-gray-400 mb-1">
                                        æ…¢æ—¥å‘¨æœŸ: <input
                                            type="number"
                                            value={Math.round(slowDay * 100) / 100}
                                            step="0.1"
                                            className="bg-gray-700 text-white px-1 rounded w-20 ml-1"
                                            onChange={(e) => {
                                                const val = Number(e.target.value);
                                                // ä¿æŒå¿«æ—¥ä¸å˜: ratio = newSlow / fast
                                                if (fastDay > 0) setSlowDayRatio(val / fastDay);
                                            }}
                                        /> å°æ—¶
                                    </label>
                                    <input
                                        type="range"
                                        min="1"
                                        max="100"
                                        step="0.1"
                                        value={slowDay}
                                        onChange={(e) => setSlowDayRatio(Number(e.target.value) / fastDay)}
                                        className="w-full"
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs text-gray-400 mb-1">
                                        æ…¢æ—¥/å¿«æ—¥æ¯”: {slowDayRatio.toFixed(4)} â†’ æ…¢æ—¥ = {slowDay.toFixed(4)} å°æ—¶
                                    </label>
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={ratioInput}
                                            onChange={(e) => setRatioInput(e.target.value)}
                                            onKeyDown={(e) => {
                                                if (e.key === 'Enter') {
                                                    const res = evaluateMath(ratioInput);
                                                    if (res != null && !isNaN(res) && res > 0) {
                                                        const val = Number(res);
                                                        setSlowDayRatio(val);
                                                        // setFastDay(slowDay / val);
                                                        setRatioInput(String(res)); // è®¡ç®—å®Œæˆåæ›¿æ¢ä¸ºç»“æœ? æˆ–è€…ä¿ç•™è¡¨è¾¾å¼? ä¿ç•™ç»“æœæ¯”è¾ƒç›´è§‚
                                                    }
                                                }
                                            }}
                                            onBlur={() => {
                                                const res = evaluateMath(ratioInput);
                                                if (res != null && !isNaN(res) && res > 0) {
                                                    const val = Number(res);
                                                    setSlowDayRatio(val);
                                                    // setFastDay(slowDay / val);
                                                    // setRatioInput(String(res)); // å¤±ç„¦æ—¶è‡ªåŠ¨è®¡ç®—? å¯é€‰
                                                }
                                            }}
                                            placeholder="è¾“å…¥è¡¨è¾¾å¼ e.g., 2*PI + 1"
                                            className="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-xs text-white"
                                        />
                                        <button
                                            onClick={() => {
                                                const res = evaluateMath(ratioInput);
                                                if (res != null && !isNaN(res) && res > 0) {
                                                    const val = Number(res);
                                                    setSlowDayRatio(val);
                                                    // setFastDay(slowDay / val);
                                                    setRatioInput(String(val));
                                                }
                                            }}
                                            className="bg-blue-700 hover:bg-blue-600 px-3 rounded text-xs"
                                        >
                                            =
                                        </button>
                                    </div>
                                    <div className="flex gap-1 mt-1 flex-wrap">
                                        {[
                                            { label: 'Ï†', val: 'phi' },
                                            { label: 'âˆš2', val: 'sqrt2' },
                                            { label: 'Ï€', val: 'pi' },
                                            { label: 'e', val: 'e' },
                                            { label: '+', val: '+' },
                                            { label: '-', val: '-' },
                                            { label: '*', val: '*' },
                                            { label: '/', val: '/' },
                                            { label: '(', val: '(' },
                                            { label: ')', val: ')' },
                                        ].map(btn => (
                                            <button
                                                key={btn.label}
                                                onClick={() => setRatioInput(prev => prev + btn.val)}
                                                className="text-xs bg-gray-700 px-2 py-0.5 rounded hover:bg-gray-600 font-mono"
                                            >
                                                {btn.label}
                                            </button>
                                        ))}
                                        <button
                                            onClick={() => setRatioInput('')}
                                            className="text-xs bg-red-900 px-2 py-0.5 rounded hover:bg-red-800"
                                        >
                                            C
                                        </button>
                                    </div>
                                </div>



                                <div>
                                    <label className="block text-xs text-gray-400 mb-1">
                                        æ˜¾ç¤ºå‘¨æœŸæ•°: {cyclesCount}
                                    </label>
                                    <input
                                        type="range"
                                        min="10"
                                        max="3000"
                                        step="1"
                                        value={cyclesCount}
                                        onChange={(e) => setCyclesCount(Number(e.target.value))}
                                        className="w-full"
                                    />
                                </div>

                                <hr className="border-gray-700" />

                                <div className="grid grid-cols-2 gap-2">
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">å¿«æ—¥èµ·å§‹ç›¸ä½</label>
                                        <input
                                            type="range"
                                            min="0"
                                            max={2 * Math.PI}
                                            step="0.1"
                                            value={startFastPhase}
                                            onChange={(e) => setStartFastPhase(Number(e.target.value))}
                                            className="w-full"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">æ…¢æ—¥èµ·å§‹ç›¸ä½</label>
                                        <input
                                            type="range"
                                            min="0"
                                            max={2 * Math.PI}
                                            step="0.1"
                                            value={startSlowPhase}
                                            onChange={(e) => setStartSlowPhase(Number(e.target.value))}
                                            className="w-full"
                                        />
                                    </div>
                                </div>

                                <hr className="border-gray-700 my-3" />

                                {/* å…¬è½¬è®¾ç½® */}
                                <div>
                                    <div className="flex justify-between items-center mb-1">
                                        <label className="block text-xs text-pink-400 font-bold">
                                            å…¬è½¬ (Revolution)
                                        </label>
                                        <input
                                            type="checkbox"
                                            checked={enableRevolution}
                                            onChange={(e) => setEnableRevolution(e.target.checked)}
                                            className="accent-pink-500"
                                        />
                                    </div>

                                    {enableRevolution && (
                                        <div className="space-y-2 pl-2 border-l-2 border-pink-900 bg-gray-900/30 p-2 rounded">
                                            <div>
                                                <label className="block text-[10px] text-gray-400 mb-1">
                                                    å…¬è½¬å‘¨æœŸ (å¹´):
                                                    <input
                                                        type="number"
                                                        value={yearLength}
                                                        onChange={(e) => setYearLength(Number(e.target.value))}
                                                        className="bg-gray-700 text-white px-1 rounded w-20 ml-2"
                                                    />
                                                    h
                                                </label>
                                                <input
                                                    type="range"
                                                    min="0"
                                                    max="100000"
                                                    step="100"
                                                    value={yearLength}
                                                    onChange={(e) => setYearLength(Number(e.target.value))}
                                                    className="w-full accent-pink-500"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-[10px] text-gray-400 mb-1">
                                                    å½“å‰å­£èŠ‚ç›¸ä½ (Â°):
                                                    <input
                                                        type="number"
                                                        value={Math.round(startYearPhase / (2 * Math.PI) * 360)}
                                                        onChange={(e) => setStartYearPhase(Number(e.target.value) * Math.PI / 180)}
                                                        className="bg-gray-700 text-white px-1 rounded w-20 ml-2"
                                                    />
                                                </label>
                                                <input
                                                    type="range"
                                                    min="0"
                                                    max={2 * Math.PI}
                                                    step="0.01"
                                                    value={startYearPhase}
                                                    onChange={(e) => setStartYearPhase(Number(e.target.value))}
                                                    className="w-full accent-pink-500"
                                                />
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* ç»Ÿè®¡ä¿¡æ¯ */}
                            <div className="mt-4 p-3 bg-gray-700 rounded">
                                <h3 className="text-sm font-semibold mb-2">ğŸ“Š ç»Ÿè®¡</h3>
                                <div className="grid grid-cols-2 gap-2 text-xs">
                                    <div className="col-span-2 text-yellow-400 font-semibold">â˜€ï¸ ç™½æ˜¼</div>
                                    <div>æœ€çŸ­: <span className="text-blue-300">{formatTime(stats.minDay)}</span></div>
                                    <div>æœ€é•¿: <span className="text-orange-300">{formatTime(stats.maxDay)}</span></div>
                                    <div className="col-span-2">å¹³å‡: <span className="text-gray-300">{formatTime(stats.avgDay)}</span></div>

                                    <div className="col-span-2 text-indigo-400 font-semibold mt-2">ğŸŒ™ é»‘å¤œ</div>
                                    <div>æœ€çŸ­: <span className="text-blue-300">{formatTime(stats.minNight)}</span></div>
                                    <div>æœ€é•¿: <span className="text-orange-300">{formatTime(stats.maxNight)}</span></div>
                                    <div className="col-span-2">å¹³å‡: <span className="text-gray-300">{formatTime(stats.avgNight)}</span></div>

                                    <div className="col-span-2 mt-2">
                                        æ€»è¯¾æ—¶: <span className="text-green-300">{stats.totalClasses}</span>
                                    </div>
                                </div>
                            </div>

                            {/* æ˜¼å¤œæ—¶é•¿å¯è§†åŒ– */}
                            <div className="mt-4">
                                <h3 className="text-sm font-semibold mb-2">ğŸ“ˆ æ˜¼å¤œæ›²çº¿</h3>
                                <div className="h-32 bg-gray-700 rounded relative overflow-hidden">
                                    <svg viewBox={`0 0 ${dayNightPairs.length} 100`} className="w-full h-full" preserveAspectRatio="none">
                                        {/* 50%åŸºå‡†çº¿ */}
                                        <line x1="0" y1="50" x2={dayNightPairs.length} y2="50" stroke="#4a5568" strokeWidth="0.5" strokeDasharray="2,2" />

                                        {/* ç™½æ˜¼æ—¶é•¿æ›²çº¿ï¼ˆæ©™è‰²ï¼‰ */}
                                        <polyline
                                            fill="none"
                                            stroke="#f6ad55"
                                            strokeWidth="1.5"
                                            points={dayNightPairs.map((d, i) =>
                                                `${i},${100 - d.dayRatio * 100}`
                                            ).join(' ')}
                                        />

                                        {/* é»‘å¤œæ—¶é•¿æ›²çº¿ï¼ˆè“è‰²ï¼‰ */}
                                        <polyline
                                            fill="none"
                                            stroke="#63b3ed"
                                            strokeWidth="1.5"
                                            points={dayNightPairs.map((d, i) =>
                                                `${i},${d.dayRatio * 100}`
                                            ).join(' ')}
                                        />
                                    </svg>
                                    <div className="absolute bottom-1 right-2 text-xs">
                                        <span className="text-orange-400">â” æ˜¼</span>
                                        <span className="text-blue-400 ml-2">â” å¤œ</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* æ—¥ç¨‹è¡¨ */}
                        <div className="lg:col-span-2 bg-gray-800 p-4 rounded-lg">
                            <h2 className="text-lg font-semibold mb-3 text-green-400">ğŸ“… æ˜¼å¤œå‘¨æœŸè¡¨</h2>

                            <div className="overflow-auto max-h-[500px]">
                                <table className="w-full text-sm">
                                    <thead className="sticky top-0 bg-gray-800">
                                        <tr className="text-gray-400 text-xs">
                                            <th className="py-2 px-1 text-left">#</th>
                                            <th className="py-2 px-1 text-left">å¿«æ—¥</th>
                                            <th className="py-2 px-1 text-left">æ…¢æ—¥</th>
                                            {enableRevolution && <th className="py-2 px-1 text-left text-pink-400">èŠ‚æ°”</th>}
                                            <th className="py-2 px-2 text-left">ç±»å‹</th>
                                            <th className="py-2 px-2 text-right">â˜€ï¸ æ˜¼</th>
                                            <th className="py-2 px-2 text-right">ğŸŒ™ å¤œ</th>
                                            <th className="py-2 px-2 text-right">è¯¾æ—¶</th>
                                            <th className="py-2 px-2 text-left">æ˜¼å¤œæ¯”</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {dayNightPairs.map((pair) => (
                                            <tr key={pair.index} className={`border-t border-gray-700 ${pair.color}`}>
                                                <td className="py-1.5 px-1 font-mono text-xs text-gray-500">{pair.index}</td>
                                                <td className="py-1.5 px-1 font-mono text-xs text-gray-400">{pair.fastDay}</td>
                                                <td className="py-1.5 px-1 font-mono text-xs text-gray-400">{pair.slowDay}</td>
                                                {enableRevolution && <td className="py-1.5 px-1 font-bold text-xs text-pink-300">{pair.solarTerm}</td>}
                                                <td className={`py-1.5 px-2 ${pair.textColor} text-xs font-medium`}>{pair.dayType}</td>
                                                <td className="py-1.5 px-2 text-right font-mono text-yellow-400">{formatTime(pair.dayDuration)}</td>
                                                <td className="py-1.5 px-2 text-right font-mono text-blue-400">{formatTime(pair.nightDuration)}</td>
                                                <td className="py-1.5 px-2 text-right font-mono">{pair.classes}</td>
                                                <td className="py-1.5 px-2 w-32">
                                                    <div className="flex h-3 rounded overflow-hidden">
                                                        <div
                                                            className="bg-yellow-500"
                                                            style={{ width: `${pair.dayRatio * 100}%` }}
                                                        />
                                                        <div
                                                            className="bg-blue-700"
                                                            style={{ width: `${(1 - pair.dayRatio) * 100}%` }}
                                                        />
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div >

                    {/* è¯´æ˜ */}
                    < div className="max-w-6xl mx-auto mt-4 bg-gray-800 p-4 rounded-lg text-sm" >
                        <h3 className="font-semibold mb-2 text-purple-400">ğŸ“– å…³äºå››ç»´æ˜¼å¤œ</h3>
                        <div className="grid md:grid-cols-2 gap-4 text-gray-300">
                            <div>
                                <p className="mb-2">
                                    å››ç»´è¡Œæ˜ŸåŒæ—¶ç»•ä¸¤ä¸ªæ­£äº¤å¹³é¢æ—‹è½¬ï¼š
                                </p>
                                <ul className="list-disc list-inside text-xs space-y-1">
                                    <li><strong>å¿«æ—¥</strong>ï¼šè¾ƒå¿«æ—‹è½¬å‘¨æœŸ ({fastDay.toFixed(4)} å°æ—¶)</li>
                                    <li><strong>æ…¢æ—¥</strong>ï¼šè¾ƒæ…¢æ—‹è½¬å‘¨æœŸ ({slowDay.toFixed(4)} å°æ—¶)</li>
                                    <li>æ¯”å€¼ = {slowDayRatio.toFixed(4)} (æ— ç†æ•° â†’ æ°¸ä¸é‡å¤)</li>
                                </ul>
                            </div>
                            <div>
                                <p className="mb-2">
                                    å¤ªé˜³é«˜åº¦ç”±ä¸¤ä¸ªæ—‹è½¬å åŠ å†³å®šã€‚å½“ä¸¤ä¸ªæ—‹è½¬"é…åˆ"æ—¶äº§ç”Ÿæé•¿æ—¥ï¼Œ"æŠµæ¶ˆ"æ—¶äº§ç”ŸæçŸ­æ—¥ã€‚
                                </p>
                                <p className="text-xs text-gray-400">
                                    æ¯ä¸ªæ˜¼å¤œå‘¨æœŸçš„é•¿åº¦ä¸å›ºå®šï¼Œå­¦æ ¡æ ¹æ®é¢„æµ‹çš„æ—¥ç…§æ—¶é•¿å®‰æ’è¯¾ç¨‹ã€‚
                                </p>
                            </div>
                        </div>
                    </div >

                </div >
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FourDScheduleV2 />);
    </script>
</body>

</html>